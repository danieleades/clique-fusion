on:
  push:
    branches: [main]
  pull_request:

name: Continuous integration

permissions:
  id-token: write

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable]
        include:
          - os: ubuntu-latest
            rust: nightly
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
      - run: cargo test --all-features

  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt
      - run: cargo fmt --all --check

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: clippy
      - uses: actions-rs-plus/clippy-check@v2
        with:
          args: --all-features --all-targets

  msrv:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: taiki-e/install-action@cargo-hack
      - run: cargo hack --no-dev-deps --rust-version check --all

  docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo doc --no-deps

  cargo-deny:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: EmbarkStudios/cargo-deny-action@v2

  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: llvm-tools-preview
      - uses: taiki-e/install-action@cargo-llvm-cov
      - run: cargo llvm-cov --all-features --doctests --workspace --lcov --output-path lcov.info
      - uses: codecov/codecov-action@v5
        with:
          files: lcov.info
          use_oidc: true
          fail_ci_if_error: true

  ffi:
    name: Native FFI Build (${{ matrix.name }})
    needs: [test, format, lint, msrv, docs, cargo-deny, coverage]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Linux
            os: ubuntu-latest
            artifact: ffi-linux-x64
            path: target/release/libclique_fusion_ffi.so
          - name: Windows
            os: windows-latest
            artifact: ffi-win-x64
            path: target/release/clique_fusion_ffi.dll
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo build --release --package clique-fusion-ffi
      - uses: actions/upload-artifact@v7
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.path }}

  csharp-linux:
    name: C# Build & Test (Linux)
    needs: [ffi]
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: csharp
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - uses: actions/download-artifact@v8
        with:
          name: ffi-linux-x64
          path: csharp/src/CliqueFusion/runtimes/linux-x64/native
      - uses: actions/download-artifact@v8
        with:
          name: ffi-win-x64
          path: csharp/src/CliqueFusion/runtimes/win-x64/native

      # 1. Restore & build core projects via solution filter
      - run: dotnet restore CliqueFusion.buildonly.slnf
      - run: dotnet build CliqueFusion.buildonly.slnf --no-restore --warnaserror --configuration Release -p:BuildNativeLibraries=false

      # 2. Pack the main library
      - run: dotnet pack src/CliqueFusion --output ./nupkgs --no-build --configuration Release -p:BuildNativeLibraries=false

      # 3. Restore full solution (SmokeTest now resolvable via nupkg)
      - run: dotnet restore

      # 4. Format verification
      - run: dotnet format CliqueFusion.sln --verify-no-changes --verbosity diagnostic

      # 5. Run all tests and SmokeTest
      - run: dotnet test --no-restore --no-build --configuration Release
      - run: dotnet build src/CliqueFusion.SmokeTest --no-restore --configuration Release
      - run: dotnet run --project src/CliqueFusion.SmokeTest --no-restore --no-build --configuration Release

      - uses: actions/upload-artifact@v7
        with:
          name: packed-nupkg
          path: csharp/nupkgs

  csharp-windows:
    name: C# Smoke Test (Windows)
    needs: csharp-linux
    runs-on: windows-latest
    defaults:
      run:
        working-directory: csharp
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"
      - uses: actions/download-artifact@v8
        with:
          name: packed-nupkg
          path: csharp/nupkgs
      - run: dotnet restore
      - run: dotnet build src/CliqueFusion.SmokeTest --no-restore --configuration Release
      - run: dotnet run --project src/CliqueFusion.SmokeTest --no-restore --no-build --configuration Release

  dependabot:
    needs:
      [
        test,
        format,
        lint,
        msrv,
        docs,
        cargo-deny,
        coverage,
        csharp-linux,
        csharp-windows,
      ]
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Enable auto-merge for Dependabot PRs
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
